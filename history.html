<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trade History</title>
<style>
  body { font-family: Inter, sans-serif; background: #07121a; color: #e6f3fb; padding: 18px; }
  h1 { margin-bottom: 10px; }
  #summary { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; display: flex; justify-content: space-around; margin-bottom: 20px; }
  .metric { text-align: center; }
  .metric h2 { margin: 0; font-size: 22px; }
  .metric p { margin: 0; font-size: 14px; color: #9fb2c8; }
  #grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px,1fr)); gap: 12px; }
  .card { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.03); }
  .h { display: flex; justify-content: space-between; align-items: center; }
  .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; }
  .long { color: #86efac; font-weight: 700; }
  .short { color: #ff7b7b; font-weight: 700; }
  .neutral { color: #9fb2c8; font-weight: 700; }
  .win { color: #86efac; font-weight: bold; }
  .loss { color: #ff7b7b; font-weight: bold; }
</style>
</head>
<body>
<h1>Trade History</h1>
<div id="summary">
  <div class="metric"><h2 id="total">0</h2><p>Total Trades</p></div>
  <div class="metric"><h2 id="wins">0</h2><p>Wins</p></div>
  <div class="metric"><h2 id="losses">0</h2><p>Losses</p></div>
  <div class="metric"><h2 id="winrate">0%</h2><p>Win Rate</p></div>
</div>
<div id="grid"><p>Loading...</p></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA1vuT6ymi7vCcn7SPE7gZKN1MyD0zBuGc",
  authDomain: "tradebeta-18ffc.firebaseapp.com",
  projectId: "tradebeta-18ffc",
  storageBucket: "tradebeta-18ffc.appspot.com",
  messagingSenderId: "786972465731",
  appId: "1:786972465731:web:7e2a6e49a36fb238e212f6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const grid = document.getElementById('grid');
const totalEl = document.getElementById('total');
const winsEl = document.getElementById('wins');
const lossesEl = document.getElementById('losses');
const winrateEl = document.getElementById('winrate');

onAuthStateChanged(auth, user => {
  if(!user) { 
    window.location.href = "login.html"; 
    return; 
  }
  loadHistory(user.uid);
});

function loadHistory(uid){
  const historyRef = collection(db, `users/${uid}/history`);
  onSnapshot(historyRef, snapshot => {
    grid.innerHTML = '';
    if(snapshot.empty){ 
      grid.innerHTML = '<p>No trades in your history.</p>'; 
      updateSummary(0,0,0);
      return; 
    }

    let total = 0, wins = 0, losses = 0;

    snapshot.forEach(docSnap => {
      const s = docSnap.data();
      total++;

      let outcome = "";
      if (s.analysisStatus === "VALIDATED") { outcome = "Win"; wins++; }
      if (s.analysisStatus === "INVALIDATED") { outcome = "Loss"; losses++; }

      const archivedAt = s.archivedAt?.toDate ? s.archivedAt.toDate() : new Date();

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="h">
          <div><h3>${s.name || "Unknown"} (${s.symbol?.toUpperCase() || "?"})</h3></div>
          <div class="badge ${s.signalType?.toLowerCase() || "neutral"}">${s.signalType || "NEUTRAL"}</div>
        </div>
        
        <p><strong>Status:</strong> ${s.analysisStatus}</p>
        <p><strong>Outcome:</strong> <span class="${outcome === "Win" ? "win" : "loss"}">${outcome || "â€”"}</span></p>
      
        <p><strong>Archived At:</strong> ${archivedAt.toLocaleString()}</p>
      `;
      grid.appendChild(card);
    });

    updateSummary(total, wins, losses);
  });
}

function updateSummary(total, wins, losses) {
  const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
  totalEl.textContent = total;
  winsEl.textContent = wins;
  lossesEl.textContent = losses;
  winrateEl.textContent = winRate + "%";
}
</script>
</body>
</html>