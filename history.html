<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trade History | TradeBeta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    /* --- DASHBOARD THEME ALIGNMENT --- */
    :root {
      --bg-deep: #030610;
      --bg-surface: #0f1623;
      --border: rgba(255, 255, 255, 0.08);
      --primary: #00f0ff;
      --success: #0aff64;
      --danger: #ff0055;
      --text-main: #ffffff;
      --text-muted: #8892b0;
      --font-head: 'Outfit', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background-color: var(--bg-deep);
      background-image: radial-gradient(circle at 85% 30%, rgba(0, 240, 255, 0.05), transparent 25%);
      font-family: var(--font-head);
      color: var(--text-main);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container { max-width: 1200px; margin: 0 auto; }

    header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
      border-bottom: 1px solid var(--border); padding-bottom: 20px;
    }
    h1 { margin: 0; font-size: 28px; letter-spacing: -1px; }
    h1 span { color: var(--primary); }

    /* --- SUMMARY STATS --- */
    #summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .metric {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .metric h2 { margin: 0; font-size: 32px; font-family: var(--font-mono); color: var(--primary); }
    .metric p { margin: 8px 0 0; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    /* --- HISTORY GRID --- */
    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
    }
    .card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: 12px;
      position: relative;
      transition: 0.3s;
    }
    .card:hover { border-color: var(--primary); transform: translateY(-3px); }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .card-header h3 { margin: 0; font-size: 18px; }
    
    .badge { padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 800; font-family: var(--font-mono); }
    .LONG { background: rgba(10, 255, 100, 0.1); color: var(--success); }
    .SHORT { background: rgba(255, 0, 85, 0.1); color: var(--danger); }

    .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
    .label { color: var(--text-muted); }
    .val { font-family: var(--font-mono); }

    .outcome-banner {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
    }
    .win-bg { background: rgba(10, 255, 100, 0.1); color: var(--success); border: 1px solid var(--success); }
    .loss-bg { background: rgba(255, 0, 85, 0.1); color: var(--danger); border: 1px solid var(--danger); }

    .timestamp { font-size: 11px; color: #444; margin-top: 12px; text-align: right; font-family: var(--font-mono); }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Performance <span>History</span></h1>
    <a href="dashboard.html" style="color: var(--text-muted); text-decoration: none; font-size: 14px;">← Back to Terminal</a>
  </header>

  <div id="summary">
    <div class="metric"><h2 id="total">0</h2><p>Total Trades</p></div>
    <div class="metric"><h2 id="wins">0</h2><p>Total Wins</p></div>
    <div class="metric"><h2 id="losses">0</h2><p>Total Losses</p></div>
    <div class="metric"><h2 id="winrate">0%</h2><p>Win Rate</p></div>
  </div>

  <div id="grid">
    <div style="color: var(--text-muted); grid-column: 1/-1; text-align: center; padding: 50px;">
      Synchronizing trade data...
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA1vuT6ymi7vCcn7SPE7gZKN1MyD0zBuGc",
    authDomain: "tradebeta-18ffc.firebaseapp.com",
    projectId: "tradebeta-18ffc",
    storageBucket: "tradebeta-18ffc.firebasestorage.app",
    messagingSenderId: "786972465731",
    appId: "1:786972465731:web:7e2a6e49a36fb238e212f6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, user => {
    if(!user) return window.location.href = "login.html";
    loadHistory(user.uid);
  });

  function loadHistory(uid) {
    const historyRef = collection(db, "users", uid, "history");
    const q = query(historyRef, orderBy("archivedAt", "desc"));

    onSnapshot(q, snapshot => {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      
      let stats = { total: 0, wins: 0, losses: 0 };

      if(snapshot.empty) {
        grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted);">No archived trades yet. Success starts with your first scan.</div>`;
        updateStats(stats);
        return;
      }

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        stats.total++;
        
        const isWin = data.analysisStatus === "VALIDATED";
        if (isWin) stats.wins++; else stats.losses++;

        const date = data.archivedAt?.toDate ? data.archivedAt.toDate().toLocaleString() : "Recently";
        const fmt = x => x ? "$" + Number(x).toLocaleString() : "-";

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            <h3>${data.name} <span style="color:var(--primary); font-size:12px;">${data.symbol}</span></h3>
            <span class="badge ${data.signalType}">${data.signalType}</span>
          </div>
          
          <div class="data-row"><span class="label">Entry</span><span class="val">${fmt(data.entry)}</span></div>
          <div class="data-row"><span class="label">Target</span><span class="val" style="color:var(--success)">${fmt(data.tp)}</span></div>
          <div class="data-row"><span class="label">Stop</span><span class="val" style="color:var(--danger)">${fmt(data.sl)}</span></div>
          
          <div class="outcome-banner ${isWin ? 'win-bg' : 'loss-bg'}">
            ${isWin ? '✓ VALIDATED (PROFIT)' : '✗ INVALIDATED (STOPPED)'}
          </div>
          <div class="timestamp">${date}</div>
        `;
        grid.appendChild(card);
      });

      updateStats(stats);
    });
  }

  function updateStats(s) {
    const rate = s.total > 0 ? Math.round((s.wins / s.total) * 100) : 0;
    document.getElementById('total').innerText = s.total;
    document.getElementById('wins').innerText = s.wins;
    document.getElementById('losses').innerText = s.losses;
    document.getElementById('winrate').innerText = rate + "%";
  }
</script>
</body>
</html>
