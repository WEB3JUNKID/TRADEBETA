<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TradeBeta Terminal v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  /* --- 1. THE THEME ENGINE --- */
  :root {
    --bg-deep: #030610;
    --bg-surface: #0f1623;
    --bg-glass: rgba(15, 22, 35, 0.7);
    --border: rgba(255, 255, 255, 0.08);
    --primary: #00f0ff; /* Cyber Cyan */
    --primary-glow: rgba(0, 240, 255, 0.25);
    --accent: #7000ff; /* Electric Purple */
    --success: #0aff64;
    --danger: #ff0055;
    --warning: #ffcc00;
    --text-main: #ffffff;
    --text-muted: #8892b0;
    --font-head: 'Outfit', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  /* --- 2. GLOBAL RESET & BASE --- */
  * { box-sizing: border-box; outline: none; }
  body {
    margin: 0;
    background-color: var(--bg-deep);
    background-image: 
      radial-gradient(circle at 15% 50%, rgba(112, 0, 255, 0.08), transparent 25%),
      radial-gradient(circle at 85% 30%, rgba(0, 240, 255, 0.05), transparent 25%);
    font-family: var(--font-head);
    color: var(--text-main);
    height: 100vh;
    display: flex;
    overflow: hidden; 
  }
  
  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

  /* --- 3. LAYOUT --- */
  .app-shell { display: flex; width: 100%; height: 100%; position: relative; }
  
  aside {
    width: 80px;
    background: var(--bg-surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 0;
    z-index: 20;
    transition: all 0.3s ease;
  }
  aside:hover { width: 240px; }
  aside:hover .link-text { opacity: 1; pointer-events: auto; }

  .brand { margin-bottom: 40px; display: flex; align-items: center; justify-content: center; width: 100%; }
  .logo-svg { width: 42px; height: 42px; filter: drop-shadow(0 0 8px var(--primary-glow)); }
  
  nav { width: 100%; flex: 1; }
  .nav-item {
    display: flex;
    align-items: center;
    padding: 16px 28px;
    color: var(--text-muted);
    text-decoration: none;
    transition: 0.2s;
    cursor: pointer;
    border-left: 3px solid transparent;
    height: 56px;
    white-space: nowrap;
  }
  .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.03); color: var(--primary); }
  .nav-item.active { border-left-color: var(--primary); background: linear-gradient(90deg, rgba(0,240,255,0.05), transparent); }
  .nav-icon { font-size: 20px; width: 24px; text-align: center; margin-right: 20px; flex-shrink: 0; }
  .link-text { opacity: 0; transition: opacity 0.2s 0.1s; font-weight: 600; font-size: 14px; pointer-events: none; }

  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    width: 100%;
  }

  header {
    height: 80px;
    padding: 0 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(3, 6, 16, 0.8);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    z-index: 5;
  }
  .page-title h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  .page-title span { color: var(--primary); }
  .page-sub { font-size: 12px; color: var(--text-muted); font-family: var(--font-mono); margin-top: 4px; }

  .actions { display: flex; gap: 12px; align-items: center; }
  
  .btn {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    color: var(--text-main);
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: var(--font-head);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.2); }
  .btn-primary {
    background: var(--primary);
    color: #000;
    border: none;
    box-shadow: 0 0 15px var(--primary-glow);
  }
  .btn-primary:hover { background: #59f6ff; transform: translateY(-1px); box-shadow: 0 0 25px var(--primary-glow); }
  
  .status-pill {
    padding: 6px 12px;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 99px;
    font-size: 11px;
    color: var(--text-muted);
    font-family: var(--font-mono);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
  .dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); animation: pulse 2s infinite; }

  /* --- 4. THE GRID & CARDS --- */
  .content-scroll { padding: 32px; overflow-y: auto; height: 100%; }
  
  #grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 24px;
  }

  .card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    overflow: hidden;
  }
  .card::before {
    content: ''; position: absolute; top:0; left:0; width: 100%; height: 2px;
    background: linear-gradient(90deg, var(--primary), transparent);
    opacity: 0; transition: opacity 0.3s;
  }
  .card:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.2); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5); }
  .card:hover::before { opacity: 1; }

  .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
  .coin-info h3 { margin: 0; font-size: 18px; font-weight: 700; }
  .coin-info .symbol { font-size: 12px; color: var(--text-muted); font-family: var(--font-mono); letter-spacing: 1px; }
  
  .badge { 
    padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase;
  }
  .badge.long { background: rgba(10, 255, 100, 0.1); color: var(--success); border: 1px solid rgba(10, 255, 100, 0.2); }
  .badge.short { background: rgba(255, 0, 85, 0.1); color: var(--danger); border: 1px solid rgba(255, 0, 85, 0.2); }

  .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
  .data-label { color: var(--text-muted); }
  .data-val { font-family: var(--font-mono); font-weight: 600; }
  .highlight { color: var(--primary); text-shadow: 0 0 10px rgba(0,240,255,0.3); }

  /* New Strength Meter */
  .strength-container { margin: 12px 0; }
  .strength-bar-bg { height: 6px; width: 100%; background: #222; border-radius: 3px; overflow: hidden; }
  .strength-bar-fill { height: 100%; width: 0%; transition: width 1s ease-out; }
  .strength-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: var(--text-muted); }
  
  .confluence-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
  .conf-tag { font-size: 10px; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #ccc; }
  .conf-tag.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 240, 255, 0.1); }

  .reason-box {
    margin-top: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    font-size: 11px;
    color: var(--text-muted);
    border-left: 2px solid var(--border);
  }

  /* --- 5. ANIMATIONS & LOADING --- */
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  #toast-container { position: fixed; bottom: 32px; right: 32px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
  .toast { 
    background: rgba(15, 22, 35, 0.9); backdrop-filter: blur(10px); 
    border: 1px solid var(--border); border-left: 3px solid var(--primary);
    padding: 16px 24px; border-radius: 8px; color: #fff; font-size: 13px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    transform: translateX(100px); opacity: 0; transition: all 0.3s;
    display: flex; align-items: center; gap: 12px;
  }
  .toast.show { transform: translateX(0); opacity: 1; pointer-events: auto; }

  /* Mobile Responsive */
  .menu-toggle { display: none; background: transparent; border: none; color: var(--primary); font-size: 24px; cursor: pointer; padding: 0; margin-right: 16px; }
  .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 15; opacity: 0; pointer-events: none; transition: 0.3s; }
  
  @media (max-width: 768px) {
    .menu-toggle { display: block; }
    aside { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
    aside:hover { width: 260px; } 
    aside .link-text { opacity: 1; pointer-events: auto; }
    .app-shell.mobile-open aside { transform: translateX(0); }
    .app-shell.mobile-open .backdrop { opacity: 1; pointer-events: auto; }
    .page-title h1 { font-size: 20px; }
    .page-sub { display: none; }
    header { padding: 0 16px; }
    #grid { grid-template-columns: 1fr; }
    .content-scroll { padding: 16px; }
  }

</style>
</head>
<body>

<div class="app-shell" id="appShell">
  <div class="backdrop" onclick="toggleMenu()"></div>

  <aside>
    <div class="brand">
      <svg class="logo-svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M50 5L93.3 30V80L50 105L6.7 80V30L50 5Z" stroke="#00F0FF" stroke-width="2" fill="rgba(0, 240, 255, 0.05)"/>
        <path d="M50 25V75M25 50H75" stroke="#7000FF" stroke-width="2" stroke-linecap="round"/>
        <circle cx="50" cy="50" r="8" fill="#00F0FF"/>
      </svg>
    </div>
    
    <nav>
      <div class="nav-item active nav-link" onclick="location.reload()">
        <div class="nav-icon">âŠž</div>
        <span class="link-text">Scanner</span>
      </div>
      <div class="nav-item nav-link" onclick="window.open('watchlist.html', '_blank')">
        <div class="nav-icon">â˜…</div>
        <span class="link-text">Watchlist</span>
      </div>
      <div class="nav-item nav-link" onclick="window.open('history.html', '_blank')">
        <div class="nav-icon">ðŸ“ƒ</div>
        <span class="link-text">History</span>
      </div>
    </nav>
  </aside>

  <main>
    <header>
      <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>

      <div class="page-title">
        <h1>Trade<span>Beta</span></h1>
        <div class="page-sub">Smart OTE + Confluence Scanner</div>
      </div>
      
      <div class="actions">
        <div class="status-pill">
          <div id="status-dot" class="dot"></div>
          <span id="status-text">System Idle</span>
        </div>
        <button class="btn btn-primary" id="refreshBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M23 4v6h-6M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
          SCAN
        </button>
      </div>
    </header>

    <div class="content-scroll">
      <div id="grid"></div>
    </div>
  </main>
</div>

<div id="toast-container"></div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  /* --- CONFIGURATION --- */
  const firebaseConfig = {
    apiKey: "AIzaSyA1vuT6ymi7vCcn7SPE7gZKN1MyD0zBuGc",
    authDomain: "tradebeta-18ffc.firebaseapp.com",
    projectId: "tradebeta-18ffc",
    storageBucket: "tradebeta-18ffc.firebasestorage.app",
    messagingSenderId: "786972465731",
    appId: "1:786972465731:web:7e2a6e49a36fb238e212f6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, u => { 
    if(!u) window.location.href="login.html"; 
    else showToast(`Welcome back, Agent ${u.uid.slice(0,5)}`);
  });

  window.toggleMenu = () => { document.getElementById('appShell').classList.toggle('mobile-open'); };
  document.querySelectorAll('.nav-link').forEach(l => {
    l.addEventListener('click', () => { if(window.innerWidth < 768) window.toggleMenu(); });
  });

  /* --- UTILITIES --- */
  const COINGECKO = "https://api.coingecko.com/api/v3";
  const TOP_SCAN = 50; 
  const RR = 3;
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const fmtUSD = x => (x==null||isNaN(x)) ? "N/A" : (Math.abs(x)>=1000 ? "$"+Number(x).toLocaleString(undefined,{maximumFractionDigits:2}) : "$"+Number(x).toFixed(5));
  
  function showToast(msg) {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div'); t.className = 'toast';
    t.innerHTML = `<span>${msg}</span>`; c.appendChild(t);
    setTimeout(()=>t.classList.add('show'), 10);
    setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300) }, 3000);
  }

  function updateStatus(msg, active=false) {
    document.getElementById('status-text').textContent = msg;
    const dot = document.getElementById('status-dot');
    if(active) dot.classList.add('active'); else dot.classList.remove('active');
  }

  if(!window.cardMap) window.cardMap = new Map();
  if(!window.cardData) window.cardData = {};

  /* --- TECHNICAL INDICATORS --- */

  function calculateEMA(prices, period) {
    if(prices.length < period) return null;
    const k = 2 / (period + 1);
    let ema = prices[0];
    for (let i = 1; i < prices.length; i++) {
      ema = prices[i] * k + ema * (1 - k);
    }
    return ema;
  }

  function detectFVG(ohlc, bias, oteHigh, oteLow) {
    // Need at least 3 candles to detect a gap from the "Leg" candle
    if(ohlc.length < 4) return false;
    
    // Structure: [..., twoDaysBefore, yest, last]
    // We check the gap created by 'twoDaysBefore' relative to 'last' or 'yest' depending on how we define the leg.
    // Simplified High-Prob FVG: Is there a gap inside the OTE zone?
    
    const yest = ohlc[ohlc.length-2];
    const dayBefore = ohlc[ohlc.length-3];
    const twoDaysBefore = ohlc[ohlc.length-4]; 

    let fvgTop, fvgBottom;

    // FVG Logic: The gap between Candle A's wick and Candle C's wick, across Candle B (the impulse)
    if (bias === "LONG") {
        // Bullish Gap: High of Candle A < Low of Candle C
        // A=twoDaysBefore, B=dayBefore(impulse), C=yest(pullback start)
        // Actually, we usually look for FVG inside the impulse leg (yest).
        // Let's look for gap inside 'yest' candle range formed by 'dayBefore' and 'last'? No 'last' is live.
        // Let's stick to: Big Body Candle check as proxy for FVG strength if exact gap calc is noisy.
        const body = Math.abs(yest.c - yest.o);
        const range = yest.h - yest.l;
        // If 70% of the candle is body, it's a displacement candle (likely FVG)
        if(body > range * 0.7) return true;
    } else {
        const body = Math.abs(yest.c - yest.o);
        const range = yest.h - yest.l;
        if(body > range * 0.7) return true;
    }
    return false;
  }

  function detectOB(ohlc, bias) {
    // Look for opposite color candle before the move
    const yest = ohlc[ohlc.length-2];
    const dayBefore = ohlc[ohlc.length-3];
    
    if (bias === "LONG") {
      // Yest (Green), DayBefore (Red)
      if (yest.c > yest.o && dayBefore.c < dayBefore.o) return true;
    } else {
      // Yest (Red), DayBefore (Green)
      if (yest.c < yest.o && dayBefore.c > dayBefore.o) return true;
    }
    return false;
  }

  /* --- STRATEGY ENGINE --- */
  
  // 1. Fetch Top Coins WITH SPARKLINE (The Speed Trick)
  async function fetchTopCoins(n){
    try {
      // We request sparkline=true to do a "Pre-Scan" filter
      const r = await fetch(`${COINGECKO}/coins/markets?vs_currency=usd&order=volume_desc&per_page=${n}&page=1&sparkline=true`);
      if(!r.ok) return [];
      const d = await r.json();
      return d.filter(c => !c.id.includes("usd") && !c.id.includes("tether") && !c.id.includes("dai"));
    } catch(e){ return []; }
  }

  // 2. The Smart Filter: Checks sparkline to see if coin is even worth fetching 30 days for
  function isWorthChecking(coin) {
    if(!coin.sparkline_in_7d || !coin.sparkline_in_7d.price) return false;
    const prices = coin.sparkline_in_7d.price;
    if(prices.length < 50) return false;

    // Compare Current Price vs Price 24 hours ago (approx 24 indexes back)
    const current = prices[prices.length-1];
    const dayAgo = prices[prices.length-24] || prices[0];
    
    const change = Math.abs(current - dayAgo) / dayAgo;
    
    // Only check coins that have moved at least 1.5% in 24h (Filter out dead/flat coins)
    if(change < 0.015) return false; 
    
    return true;
  }

  async function fetchDailyOHLC(id){
    try {
      // We fetch 30 days to calculate EMA 21 correctly
      const r = await fetch(`${COINGECKO}/coins/${id}/ohlc?vs_currency=usd&days=30`);
      if(!r.ok) return null;
      const j = await r.json();
      // [Time, Open, High, Low, Close]
      return j.map(x=>({t:x[0],o:x[1],h:x[2],l:x[3],c:x[4]}));
    } catch(e){ return null; }
  }

  async function analyzeCoin(coin){
    const ohlc = await fetchDailyOHLC(coin.id);
    if(!ohlc || ohlc.length < 25) return null; 
    
    const last = ohlc[ohlc.length-1];     // Today (Live)
    const yest = ohlc[ohlc.length-2];     // Yesterday (Confirmed)
    const dayBefore = ohlc[ohlc.length-3];

    // --- 1. BASE TREND (Bias) ---
    let bias = "NEUTRAL";
    if(yest.c > dayBefore.c) bias = "LONG";
    else if(yest.c < dayBefore.c) bias = "SHORT";
    if(bias === "NEUTRAL") return null;

    // --- 2. OTE CALC ---
    const yRange = yest.h - yest.l;
    let idealEntry, sl, tp, oteHigh, oteLow;

    if(bias === "LONG"){
      oteHigh = yest.h - (yRange * 0.62); 
      oteLow = yest.h - (yRange * 0.79);
      idealEntry = (oteHigh + oteLow) / 2;
      sl = yest.l * 0.995; 
      tp = idealEntry + ((idealEntry - sl) * RR);
    } else {
      oteLow = yest.l + (yRange * 0.62);
      oteHigh = yest.l + (yRange * 0.79);
      idealEntry = (oteHigh + oteLow) / 2;
      sl = yest.h * 1.005;
      tp = idealEntry - ((sl - idealEntry) * RR);
    }

    const currentPrice = last.c;
    const dist = Math.abs(currentPrice - idealEntry)/idealEntry;
    
    // --- 3. FILTER: MUST BE NEAR OTE ---
    // If price is too far away, discard immediately (Don't render useless cards)
    let status = "WAIT";
    // Expanded range slightly to 3% to catch more setups
    if(dist < 0.03) status = "OPEN"; 
    else if(bias==="LONG" && currentPrice > idealEntry && currentPrice < yest.h) status = "WAIT"; 
    else if(bias==="SHORT" && currentPrice < idealEntry && currentPrice > yest.l) status = "WAIT";
    
    if(status !== "OPEN" && status !== "WAIT") return null;

    // --- 4. STRENGTH SCORING ---
    let score = 50; // Base: Trend + OTE Proximity
    let confluences = ["Trend", "OTE Zone"];
    
    // A. EMA Cross (9 & 21)
    const closes = ohlc.map(c => c.c);
    const ema9 = calculateEMA(closes, 9);
    const ema21 = calculateEMA(closes, 21);
    
    let emaValid = false;
    if(bias === "LONG" && ema9 > ema21) emaValid = true;
    if(bias === "SHORT" && ema9 < ema21) emaValid = true;
    
    if(emaValid) { score += 17; confluences.push("EMA 9/21"); }

    // B. FVG (Momentum Proxy)
    let fvgDetected = detectFVG(ohlc, bias, oteHigh, oteLow);
    if(fvgDetected) { score += 17; confluences.push("FVG"); }

    // C. Order Block
    let obDetected = detectOB(ohlc, bias);
    if(obDetected) { score += 16; confluences.push("Order Block"); }

    return {
      coin,
      signal: { 
        type: bias, status, entry: idealEntry, current: currentPrice, 
        tp, sl, score: Math.min(Math.round(score), 100), reasons: confluences
      }
    };
  }

  /* --- RENDERER --- */
  const grid = document.getElementById('grid');

  function renderCard(res){
    const { coin, signal } = res;
    const id = coin.id;
    
    // Color Logic
    let barColor = "var(--primary)";
    if(signal.score >= 80) barColor = "var(--success)";
    else if(signal.score >= 60) barColor = "var(--warning)";

    const tags = signal.reasons.map(r => `<span class="conf-tag active">${r}</span>`).join('');
    
    window.cardData[id] = { ...signal, symbol: coin.symbol.toUpperCase() };

    const html = `
      <div class="card-header">
        <div class="coin-info">
          <h3>${coin.name}</h3>
          <span class="symbol">${coin.symbol.toUpperCase()}</span>
        </div>
        <div class="badge ${signal.type==="LONG"?"long":"short"}">${signal.type}</div>
      </div>

      <div class="strength-container">
        <div class="strength-label">
          <span>Setup Strength</span>
          <span style="color:${barColor}; font-weight:700;">${signal.score}%</span>
        </div>
        <div class="strength-bar-bg">
          <div class="strength-bar-fill" style="width:${signal.score}%; background:${barColor}"></div>
        </div>
      </div>
      
      <div class="confluence-tags">${tags}</div>

      <div class="data-row">
        <span class="data-label">Price</span>
        <span class="data-val">${fmtUSD(signal.current)}</span>
      </div>
      <div class="data-row">
        <span class="data-label" style="color:var(--primary)">OTE Entry</span>
        <span class="data-val highlight">${fmtUSD(signal.entry)}</span>
      </div>
      
      <div style="margin: 12px 0; border-top:1px solid var(--border); padding-top:12px;">
         <div class="data-row">
            <span class="data-label">Target (3R)</span>
            <span class="data-val" style="color:var(--success)">${fmtUSD(signal.tp)}</span>
         </div>
         <div class="data-row">
            <span class="data-label">Stop Loss</span>
            <span class="data-val" style="color:var(--danger)">${fmtUSD(signal.sl)}</span>
         </div>
      </div>

      <button class="btn btn-primary" style="width:100%; margin-top:16px; justify-content:center;" onclick="track('${id}')">
        ADD TO WATCHLIST
      </button>
    `;

    let card = window.cardMap.get(id);
    if(!card){
      card = document.createElement('div');
      card.className = 'card';
      grid.appendChild(card);
      window.cardMap.set(id, card);
      card.style.animation = "pulse 0.5s ease";
    }
    card.innerHTML = html;
  }

  /* --- ACTIONS --- */
  window.track = async (id) => {
    if(!auth.currentUser) return showToast("Login required");
    const btn = window.cardMap.get(id).querySelector('button');
    btn.innerText = "SAVING...";
    try {
      await addDoc(collection(db, "users", auth.currentUser.uid, "watchlist"), {
        ...window.cardData[id], trackedAt: Date.now()
      });
      showToast("Added to Watchlist");
      btn.innerText = "TRACKED âœ”";
      btn.disabled = true;
    } catch(e){ showToast("Error saving"); }
  };

  async function run(){
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    grid.innerHTML = '';
    window.cardMap.clear();
    
    updateStatus("Fetching Top Coins...", true);
    
    // 1. Fetch Basic Data (Fast)
    const coins = await fetchTopCoins(TOP_SCAN);
    
    let scannedCount = 0;
    
    // 2. Intelligent Loop
    for(let i=0; i<coins.length; i++){
      const c = coins[i];
      
      // PRE-FILTER: Skip coins that are flat (haven't moved in 24h) to save time/API
      if(!isWorthChecking(c)) {
         updateStatus(`Skipping ${c.symbol.toUpperCase()} (Flat/No Volatility)...`, true);
         // No sleep needed here! Speed up!
         continue; 
      }

      // If we are here, the coin is moving. Now we spend the time to fetch details.
      updateStatus(`Analyzing ${c.symbol.toUpperCase()} (${i+1}/${coins.length})`, true);
      scannedCount++;
      
      const res = await analyzeCoin(c);
      if(res) renderCard(res);
      
      // Only sleep if we actually made a "Heavy" API call
      await sleep(1100); 
    }
    
    updateStatus("Scan Complete", false);
    btn.disabled = false;
    if(grid.innerHTML === '') grid.innerHTML = `<div style="padding:20px; color:#888; text-align:center;">No high-strength setups found in top ${TOP_SCAN} coins.<br>Try again later.</div>`;
  }

  document.getElementById('refreshBtn').onclick = run;
</script>
</body>
</html>
