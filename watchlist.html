<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Live Watchlist | TradeBeta</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #030610;
    --bg-surface: #0f1623;
    --border: rgba(255, 255, 255, 0.08);
    --primary: #00f0ff;
    --success: #0aff64;
    --danger: #ff0055;
    --warning: #ffcc00;
    --text-main: #ffffff;
    --text-muted: #8892b0;
    --font-head: 'Outfit', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0; background-color: var(--bg-deep); color: var(--text-main);
    font-family: var(--font-head); min-height: 100vh;
    background-image: radial-gradient(circle at 10% 10%, rgba(0, 240, 255, 0.05), transparent 30%);
  }

  .container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }

  header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px;
  }
  h1 { margin: 0; font-size: 26px; }
  h1 span { color: var(--primary); }

  .back-btn {
    text-decoration: none; color: var(--text-muted); font-size: 13px;
    padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border);
    transition: 0.2s;
  }
  .back-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }

  /* --- TRACKING CARD DESIGN --- */
  .list-container { display: flex; flex-direction: column; gap: 16px; }

  .track-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    display: grid;
    grid-template-columns: 1.5fr 1fr 1fr 1fr auto;
    align-items: center;
    gap: 24px;
    transition: 0.3s;
    position: relative;
    overflow: hidden;
  }
  .track-card:hover { border-color: rgba(0, 240, 255, 0.3); transform: translateX(4px); }
  
  /* Visual indicator for Long/Short */
  .track-card.LONG { border-left: 4px solid var(--success); }
  .track-card.SHORT { border-left: 4px solid var(--danger); }

  .asset-info h3 { margin: 0; font-size: 18px; }
  .asset-info .symbol { font-family: var(--font-mono); color: var(--primary); font-size: 12px; }

  .price-box { display: flex; flex-direction: column; gap: 4px; }
  .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
  .val { font-family: var(--font-mono); font-size: 14px; font-weight: 600; }

  /* Strength Meter mini version */
  .mini-strength { width: 100px; }
  .bar-bg { height: 4px; background: #222; border-radius: 2px; margin-top: 4px; }
  .bar-fill { height: 100%; border-radius: 2px; transition: 1s; }

  .conf-list { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
  .tag { font-size: 9px; padding: 2px 6px; background: rgba(255,255,255,0.05); border-radius: 3px; color: #aaa; }

  .status-badge {
    font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 4px;
    background: rgba(255, 204, 0, 0.1); color: var(--warning); border: 1px solid var(--warning);
    animation: pulse 2s infinite;
  }

  .btn-stop {
    background: none; border: 1px solid var(--border); color: #555;
    padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.2s;
  }
  .btn-stop:hover { color: var(--danger); border-color: var(--danger); background: rgba(255,0,85,0.05); }

  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

  @media (max-width: 850px) {
    .track-card { grid-template-columns: 1fr 1fr; gap: 16px; }
    .btn-stop { grid-column: span 2; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Live <span>Watchlist</span></h1>
    <a href="dashboard.html" class="back-btn">← Terminal</a>
  </header>

  <div id="watchlist-container" class="list-container">
    <p style="text-align:center; color:var(--text-muted); padding:40px;">Establishing secure connection to trade data...</p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, deleteDoc, doc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA1vuT6ymi7vCcn7SPE7gZKN1MyD0zBuGc",
    authDomain: "tradebeta-18ffc.firebaseapp.com",
    projectId: "tradebeta-18ffc",
    storageBucket: "tradebeta-18ffc.firebasestorage.app",
    messagingSenderId: "786972465731",
    appId: "1:786972465731:web:7e2a6e49a36fb238e212f6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let trades = [];

  onAuthStateChanged(auth, user => {
    if(!user) return window.location.href="login.html";
    
    onSnapshot(collection(db, "users", user.uid, "watchlist"), (snap) => {
      trades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateAndRender();
    });

    setInterval(updateAndRender, 60000);
  });

  async function updateAndRender() {
    const container = document.getElementById('watchlist-container');
    if(trades.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding:60px; color:#444; border:1px dashed var(--border); border-radius:12px;">No active setups being tracked.</div>`;
      return;
    }

    const ids = [...new Set(trades.map(t => t.coin?.id).filter(Boolean))];
    let livePrices = {};
    
    try {
      const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids.join(',')}&vs_currencies=usd`);
      livePrices = await res.json();
    } catch(e) { console.error("Price sync failed"); }

    const fmt = x => x ? "$"+Number(x).toLocaleString(undefined, {minimumFractionDigits: 2}) : "-";

    container.innerHTML = "";
    
    for (const t of trades) {
      const currentPrice = livePrices[t.coin?.id]?.usd;
      
      // Auto-Archive Logic
      let finalStatus = null;
      if(currentPrice) {
        if(t.type === "LONG") {
          if(currentPrice >= t.tp) finalStatus = "VALIDATED";
          else if(currentPrice <= t.sl) finalStatus = "INVALIDATED";
        } else {
          if(currentPrice <= t.tp) finalStatus = "VALIDATED";
          else if(currentPrice >= t.sl) finalStatus = "INVALIDATED";
        }
      }

      if(finalStatus) {
        await archiveTrade(t, finalStatus);
        continue; 
      }

      // Render Detailed Card
      const card = document.createElement('div');
      card.className = `track-card ${t.type}`;
      
      const scoreColor = t.score >= 80 ? 'var(--success)' : (t.score >= 60 ? 'var(--warning)' : 'var(--primary)');
      const tags = (t.reasons || []).map(r => `<span class="tag">${r}</span>`).join('');

      card.innerHTML = `
        <div class="asset-info">
          <div class="label">Tracking Asset</div>
          <h3>${t.coin?.name || 'Unknown'} <span class="symbol">${t.symbol}</span></h3>
          <div class="conf-list">${tags}</div>
        </div>

        <div class="price-box">
          <div class="label">Entry Zone</div>
          <div class="val" style="color:var(--primary)">${fmt(t.entry)}</div>
          <div class="mini-strength">
            <div class="bar-bg"><div class="bar-fill" style="width:${t.score}%; background:${scoreColor}"></div></div>
          </div>
        </div>

        <div class="price-box">
          <div class="label">Live / Target</div>
          <div class="val">${fmt(currentPrice || t.current)}</div>
          <div class="val" style="color:var(--success); font-size:11px;">Target: ${fmt(t.tp)}</div>
        </div>

        <div class="price-box">
           <div class="label">Current Status</div>
           <div class="status-badge">LIVE TRACKING</div>
           <div class="val" style="color:var(--danger); font-size:11px; margin-top:4px;">Stop: ${fmt(t.sl)}</div>
        </div>

        <button class="btn-stop" title="Stop Tracking" onclick="window.remove('${t.id}')">✕</button>
      `;
      container.appendChild(card);
    }
  }

  async function archiveTrade(trade, status) {
    const uid = auth.currentUser.uid;
    await addDoc(collection(db, "users", uid, "history"), {
      name: trade.coin?.name || "Unknown",
      symbol: trade.symbol,
      signalType: trade.type,
      analysisStatus: status,
      archivedAt: serverTimestamp(),
      entry: trade.entry,
      tp: trade.tp,
      sl: trade.sl
    });
    await deleteDoc(doc(db, "users", uid, "watchlist", trade.id));
  }

  window.remove = async (id) => {
    if(confirm("Stop tracking this asset?")) {
      await deleteDoc(doc(db, "users", auth.currentUser.uid, "watchlist", id));
    }
  };
</script>
</body>
</html>
